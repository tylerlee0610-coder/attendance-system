{% extends "base.html" %}
{% block title %}補卡審核{% endblock %}
{% block content %}
<div class="bg-white border border-slate-200 rounded-2xl shadow-lg p-6 space-y-4 transition transform hover:-translate-y-0.5 hover:shadow-xl">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-lg font-semibold text-slate-800">補卡審核</h2>
            <p class="text-sm text-slate-500">審核補打卡申請</p>
        </div>
        <button type="button" onclick="loadManual()" class="px-3 py-2 rounded-md bg-primary-600 text-white text-sm font-semibold hover:bg-primary-700">重新整理</button>
    </div>
    <div id="manual" class="text-sm text-slate-700"></div>
</div>
<script>
(function() {
    console.log("manager manual review script loaded");

    function renderTable(data) {
        var box = document.getElementById("manual");
        if (!Array.isArray(data) || data.length === 0) {
            box.textContent = "目前沒有待審核的補卡";
            return;
        }
        var html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200">';
        html += '<thead class="bg-slate-50"><tr>' +
            '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">ID</th>' +
            '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">員工</th>' +
            '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">類型</th>' +
            '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">時間</th>' +
            '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">原因</th>' +
            '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">狀態</th>' +
            '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">操作</th>' +
            '</tr></thead><tbody class="divide-y divide-slate-200">';
        data.forEach(function(r) {
            var ts = r.requested_ts ? new Date(r.requested_ts).toLocaleString() : "";
            html += '<tr class="hover:bg-slate-50">' +
                '<td class="px-3 py-2 text-sm text-slate-800">' + r.id + '</td>' +
                '<td class="px-3 py-2 text-sm text-slate-800">' + (r.username || r.user_id) + '</td>' +
                '<td class="px-3 py-2 text-sm text-slate-800">' + r.check_type + '</td>' +
                '<td class="px-3 py-2 text-sm text-slate-800">' + ts + '</td>' +
                '<td class="px-3 py-2 text-sm text-slate-800">' + (r.reason || '') + '</td>' +
                '<td class="px-3 py-2 text-sm text-slate-800">' + r.status + '</td>' +
                '<td class="px-3 py-2 text-sm text-slate-800 space-x-2">' +
                    '<button type="button" onclick="review(' + r.id + ', \'APPROVE\')" class="px-3 py-1.5 rounded-md bg-emerald-600 text-white text-xs font-semibold hover:bg-emerald-700">同意</button>' +
                    '<button type="button" onclick="review(' + r.id + ', \'REJECT\')" class="px-3 py-1.5 rounded-md bg-red-600 text-white text-xs font-semibold hover:bg-red-700">退回</button>' +
                '</td>' +
                '</tr>';
        });
        html += '</tbody></table></div>';
        box.innerHTML = html;
    }

    window.loadManual = async function() {
        var box = document.getElementById("manual");
        box.textContent = "載入中...";
        try {
            var res = await fetch("/api/manager/manual?status_filter=PENDING", {
                method: "GET",
                credentials: "same-origin"
            });
            if (res.redirected) { window.location.href = res.url; return; }
            if (!res.ok) { box.textContent = "讀取失敗: HTTP " + res.status; return; }
            var data = await res.json();
            renderTable(data);
        } catch (e) {
            box.textContent = "Error: " + e;
        }
    };

    window.review = async function(id, action) {
        var box = document.getElementById("manual");
        box.textContent = "送出中...";
        try {
            var res = await fetch("/api/manager/manual/" + id, {
                method: "POST",
                credentials: "same-origin",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: action })
            });
            if (res.redirected) { window.location.href = res.url; return; }
            if (!res.ok) { box.textContent = "更新失敗: HTTP " + res.status; return; }
            loadManual();
        } catch (e) {
            box.textContent = "Error: " + e;
        }
    };

    loadManual();
})();
</script>
{% endblock %}
