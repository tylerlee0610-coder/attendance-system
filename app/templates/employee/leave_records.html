{% extends "base.html" %}
{% block title %}我的請假紀錄{% endblock %}
{% block content %}
{% set role = request.session.get("role") if request.session else None %}
<div class="bg-white border border-slate-200 rounded-2xl shadow-lg p-6 space-y-4 transition transform hover:-translate-y-0.5 hover:shadow-xl">
    <div class="flex items-center justify-between">
        <div>
            {% if role == "manager" or role == "admin" %}
            <h2 class="text-lg font-semibold text-slate-800">團隊請假紀錄</h2>
            <p class="text-sm text-slate-500">可依 UserID 或姓名過濾</p>
            {% else %}
            <h2 class="text-lg font-semibold text-slate-800">我的請假紀錄</h2>
            <p class="text-sm text-slate-500">最新 50 筆</p>
            {% endif %}
        </div>
        <div class="flex items-center gap-2">
            {% if role == "manager" or role == "admin" %}
            <input id="user_id" type="number" min="1" placeholder="User ID (可選)"
                   class="w-32 rounded-md border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            <input id="user_name" type="text" placeholder="姓名 (可選)"
                   class="w-36 rounded-md border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            {% endif %}
            <button type="button" onclick="loadLeaves()" class="px-3 py-2 rounded-md bg-primary-600 text-white text-sm font-semibold hover:bg-primary-700">重新整理</button>
        </div>
    </div>
    <div id="leaves" class="text-sm text-slate-700"></div>
</div>
<script>
(function() {
    console.log("leave records script loaded");
    var isManager = {{ "true" if role == "manager" or role == "admin" else "false" }};

    function renderTable(data) {
        var box = document.getElementById("leaves");
        if (!Array.isArray(data) || data.length === 0) {
            box.textContent = "尚無請假紀錄";
            return;
        }
        var html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200">';
        if (isManager) {
            html += '<thead class="bg-slate-50"><tr>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">ID</th>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">姓名</th>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">UserID</th>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">帳號</th>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">假別</th>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">開始</th>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">結束</th>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">狀態</th>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">原因</th>' +
                '</tr></thead><tbody class="divide-y divide-slate-200">';
        } else {
            html += '<thead class="bg-slate-50"><tr>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">ID</th>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">假別</th>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">開始</th>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">結束</th>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">狀態</th>' +
                '<th class="px-3 py-2 text-left text-xs font-semibold text-slate-600">原因</th>' +
                '</tr></thead><tbody class="divide-y divide-slate-200">';
        }
        data.forEach(function(r) {
            var st = r.start_time ? new Date(r.start_time).toLocaleString() : "";
            var et = r.end_time ? new Date(r.end_time).toLocaleString() : "";
            if (isManager) {
                html += '<tr class="hover:bg-slate-50">' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + r.id + '</td>' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + (r.name || '') + '</td>' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + (r.user_id || '') + '</td>' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + (r.username || '') + '</td>' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + r.leave_type + '</td>' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + st + '</td>' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + et + '</td>' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + r.status + '</td>' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + (r.reason || '') + '</td>' +
                    '</tr>';
            } else {
                html += '<tr class="hover:bg-slate-50">' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + r.id + '</td>' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + r.leave_type + '</td>' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + st + '</td>' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + et + '</td>' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + r.status + '</td>' +
                    '<td class="px-3 py-2 text-sm text-slate-800">' + (r.reason || '') + '</td>' +
                    '</tr>';
            }
        });
        html += '</tbody></table></div>';
        box.innerHTML = html;
    }

    window.loadLeaves = async function() {
        var box = document.getElementById("leaves");
        var userIdEl = document.getElementById("user_id");
        var userNameEl = document.getElementById("user_name");
        var userId = userIdEl ? userIdEl.value : "";
        var userName = userNameEl ? userNameEl.value : "";
        var url = "/api/leave/mine";
        if (isManager) {
            var params = [];
            if (userId) params.push("user_id=" + encodeURIComponent(userId));
            if (userName) params.push("name=" + encodeURIComponent(userName));
            if (params.length) {
                url += "?" + params.join("&");
            }
        }
        box.textContent = "載入中...";
        try {
            var res = await fetch(url, {
                method: "GET",
                credentials: "same-origin"
            });
            if (res.redirected) {
                window.location.href = res.url;
                return;
            }
            if (!res.ok) {
                box.textContent = "讀取失敗: HTTP " + res.status;
                return;
            }
            var data = await res.json();
            renderTable(data);
        } catch (e) {
            box.textContent = "Error: " + e;
        }
    };

    loadLeaves();
})();
</script>
{% endblock %}
